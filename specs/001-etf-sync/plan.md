# Implementation Plan: ETF Data Synchronization

**Branch**: `001-etf-sync` | **Date**: 2025-01-27 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-etf-sync/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command.

## Summary

本功能将实现ETF数据同步，包括：
1. 添加ETF标记字段到数据库schema
2. 从远程API获取ETF列表并存储
3. 支持ETF历史价格数据同步

技术方法：扩展现有的股票数据同步机制，添加ETF特定的API端点支持，复用现有的TimescaleDB存储结构。

## Technical Context

**Language/Version**: Python 3.9.6+  
**Primary Dependencies**: SQLAlchemy 2.0.23, Flask 3.0.0, TimescaleDB (PostgreSQL), Pandas 2.1.4, Requests 2.31.0  
**Storage**: TimescaleDB (PostgreSQL 时序数据库扩展)  
**Testing**: pytest (需要添加测试框架)  
**Target Platform**: Linux server (Ubuntu/Debian)
**Project Type**: single (Backend REST API服务)
**Performance Goals**: 
- API响应时间 < 500ms (p95)
- 支持批量同步10+ ETFs/秒
- 数据库查询 < 100ms (p95)
**Constraints**: 
- API调用需要处理限流和错误重试
- 数据库连接池管理 (pool_size=10, max_overflow=20)
- 支持增量同步，避免重复数据
**Scale/Scope**: 
- 处理数百只ETF
- 存储历史价格数据（数万条记录）
- API支持多个交易所（上海、深圳）

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

本项目需要检查以下合规性要点：

1. **数据库Schema扩展** - ETF标记字段需要添加到现有表结构
2. **API端点集成** - 新的ETF API端点需要与现有股票API集成
3. **数据迁移** - 需要考虑现有数据与ETF数据的兼容性
4. **错误处理** - 遵循现有的API错误处理模式

## Project Structure

### Documentation (this feature)

```text
specs/001-etf-sync/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
│   └── openapi.yaml     # API contract specification
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

本项目采用单一后端结构，代码组织如下：

```text
app/
├── models/
│   └── stock_data.py           # 需要添加 is_etf 字段
├── services/
│   ├── stock_info_service.py   # 现有服务
│   ├── stock_data_service.py   # 现有服务
│   ├── sync_service.py         # 需要添加 ETF 同步逻辑
│   └── etf_sync_service.py     # 新建：ETF专用同步服务
├── routes/
│   ├── stock_info.py
│   ├── stock_price.py
│   └── etf_routes.py           # 新建：ETF API路由
└── utils/
    └── responses.py

data_fetcher/
├── stock_api.py                # 现有股票API
└── etf_api.py                  # 新建：ETF API数据获取

models/
└── stock_data.py              # 需要扩展 schema

database/
└── connection.py               # 数据库连接管理
```

**Structure Decision**: 
本特征采用现有单一后端结构。ETF功能作为现有股票功能的扩展：
- 复用现有的数据库模型和同步机制
- 在现有 services/ 中添加 ETF 专用服务
- 在现有 routes/ 中添加 ETF API 端点
- 创建新的 data_fetcher/etf_api.py 处理ETF特定的API调用

这种方法的优势：
- 最大化代码复用
- 保持架构一致性
- 减少数据库schema变更

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
